<dom-module id="mappool-page">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning">
			mappool-item {
				margin: 10px;
				flex: none;
			}
			.tier-selector {
				margin: 10px;
				width: 300px;
			}
			.header {
      	color: var(--happystick-green);
      	font-size: 40px;
      }
      .mappack-button {
      	background-color: var(--happystick-green);
      	color: white;
      	margin: 20px;
      	width: 900px;
      }
		</style>
		<iron-ajax id="roundsAjax" url="../api/tiers//rounds" method="GET" last-response="{{rounds}}"></iron-ajax>
		<iron-ajax id="mappoolAjax" url="../api/rounds//mappool" method="GET" last-response="{{mappool}}"></iron-ajax>
		<div class="flex layout vertical">
			<paper-dropdown-menu class="tier-selector" label="Round" hidden$="[[round_hidden]]">
				<paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{selected_round}}">
					<template is="dom-repeat" items="[[rounds]]" as="round">
						<paper-item value="[[round.id]]">[[round.name]]</paper-item>
					</template>
				</paper-listbox>
			</paper-dropdown-menu>
			<paper-button class="mappack-button" raised on-click="downloadMappack">Download mappack</paper-button>
			<template is="dom-repeat" items="[[mappool.slots]]" as="slot">
				<div class="layout horizontal" style="margin:20px;">
					<mappool-item beatmap-id="[[slot.beatmap.beatmap_id]]" map="[[slot.beatmap]]" mods="[[slot.mods]]" freemod="[[slot.freemod]]" tiebreaker="[[slot.tiebreaker]]" picked$="[[slot.picked]]" banned$="[[slot.banned]]"></mappool-item>
					<a href="https://osu.ppy.sh/d/[[slot.beatmap.beatmapset_id]]" target="_blank"><img src="../images/download.png" style="height:150px;margin-left:10px;"></a>
					<a href="osu://b/[[slot.beatmap.beatmap_id]]"><img src="../images/direct.png" style="height:150px;margin-left:10px;"></a>
					<a href="http://bloodcat.com/osu/s/[[slot.beatmap.beatmapset_id]]" style="height:150px;margin-left:10px;"></a>
				</div>
			</template>
		</div>
	</template>
	<script>
		addEventListener('WebComponentsReady', () => {
			Polymer({
				is: 'mappool-page',
				properties: {
					tier: {
						type: Number,
						observer: 'tierChanged'
					},
					selected_round: {
						type: Number,
						observer: 'selected_roundChanged'
					},
					round_hidden: {
						type: Boolean,
						value: true
					}
				},
				tierChanged: function() {
					this.rounds = [];
					if (this.tier.id) {
						this.$.roundsAjax.url = '../api/tiers/' + this.tier.id + '/rounds';
						this.$.roundsAjax.headers = {
							'Authorization': localStorage.getItem('token')
						};
						this.$.roundsAjax.generateRequest();
						this.round_hidden = false;
					}
				},
				selected_roundChanged: function() {
					if (this.selected_round) {
						this.$.mappoolAjax.url = '../api/rounds/' + this.selected_round + '/mappool';
						this.$.mappoolAjax.headers = {
							'Authorization': localStorage.getItem('token')
						};
						this.$.mappoolAjax.generateRequest();
					} else {
						this.mappool = [];
					}
				},
				downloadMappack: function() {
					window.open(this.mappool.mappack);
				}
			});
		});
	</script>
</dom-module>