<dom-module id="lobby-page">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning">
			paper-tabs {
        background-color: var(--discord-grey);
        color: white;
        --paper-tabs-selection-bar-color: var(--happystick-green);
      }
      overall-item {
      	margin-top: 10px;
      }
      .green-button {
      	background-color: var(--happystick-green);
      	color: white;
      	margin: 10px;
      	width: 300px;
      }
      .red-button {
      	background-color: var(--error-red);
      	color: white;
      	margin: 10px;
      	width: 300px;
      }
      .header {
      	color: var(--happystick-green);
      	font-size: 40px;
      }
      .mappack-button {
      	background-color: var(--happystick-green);
      	color: white;
      	margin: 20px;
      	width: 900px;
      }
      .feedback-input {
      	width: 900px;
      	margin-left: 20px;
      }
      .success-toast {
				background-color: var(--happystick-green);
				color: white;
			}
			.error-toast {
				background-color: var(--error-red);
				color: white;
			}
		</style>
		<iron-ajax id="lobbyAjax" url="../api/lobbies/" method="GET" on-response="lobbyResponse" last-response="{{lobby}}"></iron-ajax>
		<iron-ajax id="mappoolAjax" url="../api/rounds//mappool" method="GET" on-response="mappoolResponse" last-response="{{mappool}}"></iron-ajax>
		<iron-ajax id="matchAjax" url="../api/matches/" method="GET" on-response="matchResponse"></iron-ajax>
		<iron-ajax id="bansAjax" url="../api/matches//bans" method="GET" on-response="bansResponse"></iron-ajax>
		<div class="layout vertical">
			<paper-tabs attr-for-selected="value" selected="{{tabSelected}}">
				<paper-tab value="Overview">Overview</paper-tab>
				<paper-tab value="Players">Players</paper-tab>
				<paper-tab value="Mappool">Mappool</paper-tab>
			</paper-tabs>
			<iron-pages attr-for-selected="value" selected="[[tabSelected]]" class="layout vertical">
				<div value="Overview" class="layout vertical">
					<div class="layout vertical" style="margin:20px;">
						<div class="header">Lobby <span>[[id]]</span></div>
						<div>Match name: <span>[[match_name]]</span></div>
						<div>MP link: <a href="https://osu.ppy.sh/mp/[[match_id]]">https://osu.ppy.sh/mp/[[match_id]]</a></div>
						<paper-button raised class="green-button" on-click="refreshLobby">Refresh</paper-button>
						<div class="header" style="margin-top:50px;">Players</div>
						<template is="dom-repeat" items="{{overall}}">
							<overall-item overall_item="{{item}}"></overall-item>
						</template>
						<div class="header" style="margin-top:50px;">Games</div>
						<template is="dom-repeat" items="[[games]]">
							<game-item game_item="[[item]]" players="[[players]]" style="margin-top:10px;" on-changed="refreshLobby"></game-item>
						</template>
					</div>
				</div>
				<div value="Players" class="layout vertical">
					<div class="layout vertical">
						<template is="dom-repeat" items="[[players]]" as="player">
							<div class="layout horizontal" style="margin:20px;">
								<osu-profile profile="[[player.user.osu_profile]]" sub_since="[[player.user.twitch_profile.sub_since]]"></osu-profile>
								<discord-profile profile="[[player.user.discord_profile]]" style="margin-left:20px;"></discord-profile>
							</div>
						</template>
					</div>
				</div>
				<div value="Mappool" class="layout vertical">
					<div class="layout vertical">
						<template is="dom-repeat" items="[[mappool.slots]]" as="slot">
							<div class="layout horizontal" style="margin:20px;">
								<mappool-item beatmap-id="[[slot.beatmap.beatmap_id]]" map="[[slot.beatmap]]" mods="[[slot.mods]]" freemod="[[slot.freemod]]" tiebreaker="[[slot.tiebreaker]]" picked$="[[slot.picked]]" banned$="[[slot.banned]]"></mappool-item>
							</div>
						</template>
					</div>
				</div>
			</iron-pages>
		</div>
		<paper-toast id="successToast" class="success-toast" text="[[toast_message]]"></paper-toast>
		<paper-toast id="errorToast" class="error-toast" text="[[toast_message]]"></paper-toast>
	</template>
	<script>
		Polymer({
			is: 'lobby-page',
			properties: {
				id: {
					type: Number,
					observer: 'idChanged'
				},
				round: {
					type: Number,
					observer: 'roundChanged'
				},
				match_id: {
					type: Number
				},
				match_name: String
			},
			idChanged: function() {
				this.tabSelected = 'Overview';
				this.$.lobbyAjax.url = '../api/lobbies/' + this.id;
				this.$.lobbyAjax.headers = {
					'Authorization': localStorage.getItem('token')
				};
				this.$.lobbyAjax.generateRequest();
			},
			roundChanged: function() {
				this.$.mappoolAjax.url = '../api/rounds/' + this.round + '/mappool';
				this.$.mappoolAjax.headers = {
					'Authorization': localStorage.getItem('token')
				};
				this.$.mappoolAjax.generateRequest();
			},
			lobbyResponse: function() {
				if (this.lobby && this.lobby.match_id) {
					this.match_id = this.lobby.match_id;
					this.$.matchAjax.url = '../api/matches/' + this.match_id;
					this.$.matchAjax.headers = {
						'Authorization': localStorage.getItem('token')
					};
					this.$.matchAjax.generateRequest();
					this.$.bansAjax.url = '../api/matches/' + this.match_id + '/bans';
					this.$.bansAjax.headers = {
						'Authorization': localStorage.getItem('token')
					};
					this.$.bansAjax.generateRequest();
					this.new_match = false;
					this.ref_comments = this.lobby.comment;
				} else {
					this.new_match = true;
				}
				this.players = this.lobby.slots;
				this.round = this.lobby.round;
			},
			refreshLobby: function() {
				this.$.lobbyAjax.generateRequest();
			},
			matchResponse: function(e) {
				this.games = [];
				this.overall = [];
				for (var player = 0; player < this.players.length; player++) {
					if (this.players[player].user.osu_profile) {
						this.push('overall', this.players[player]);
						this.overall[this.overall.length - 1].score = 0;
						if (this.players[player].continue_to_upper == '1' && this.players[player].drop_down == '0') {
							this.overall[this.overall.length - 1].continues = 'Continues';
						} else if (this.players[player].continue_to_upper == '0' && this.players[player].drop_down == '1') {
							this.overall[this.overall.length - 1].continues = 'Drops down';
						} else if (this.players[player].continue_to_upper == '0' && this.players[player].drop_down == '0') {
							this.overall[this.overall.length - 1].continues = 'Eliminated';
						}
					}
				}
				var games = e.detail.response.games;
				for (var game = 0; game < games.length; game++) {
					if (games[game].counts == '1') {
						var scoreAdd = this.players.length > 2 ? 6 : 1;
						for (var score = 0; score < games[game].scores.length; score++) {
							for (var player = 0; player < this.overall.length; player++) {
								if (games[game].scores[score].user_id == this.overall[player].user.osu_profile.user_id) {
									this.overall[player].score += scoreAdd;
									games[game].scores[score].points = scoreAdd;
									switch (scoreAdd) {
										case 6: scoreAdd = 4; break;
										case 4: scoreAdd = 3; break;
										case 3: scoreAdd = 2; break;
										case 2: scoreAdd = 0; break;
										case 1: scoreAdd = 0; break;
									}
								}
							}
						}
					}
					for (var slot = 0; slot < this.mappool.slots.length; slot++) {
						if (this.mappool.slots[slot].beatmap.beatmap_id == games[game].beatmap_id) {
							games[game].tiebreaker = this.mappool.slots[slot].tiebreaker;
							games[game].freemod = this.mappool.slots[slot].freemod;
							if (games[game].counts == '1') {
								this.set('mappool.slots.' + slot + '.picked', true);
							}
						}
					}
					this.push('games', games[game]);
				}
				this.overall.sort(function(a, b) {
					return b.score - a.score;
				});
			},
			bansResponse: function(e) {
				var response = e.detail.response;
				for (var slot = 0; slot < this.mappool.slots.length; slot++) {
					this.set('mappool.slots.' + slot + '.banned', false);
					this.set('mappool.slots.' + slot + '.banned_by', '');
				}
				for (var i = 0; i < response.length; i++) {
					for (var slot = 0; slot < this.mappool.slots.length; slot++) {
						if (this.mappool.slots[slot].beatmap.beatmap_id == response[i].beatmap_id) {
							this.set('mappool.slots.' + slot + '.banned', true);
							this.set('mappool.slots.' + slot + '.banned_by', response[i].user.discord_profile.id);
						}
					}
				}
			},
			mappoolResponse: function() {
				this.$.bansAjax.generateRequest();
			}
		});
	</script>
</dom-module>

<dom-module id="overall-item">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning"></style>
		<div class="layout horizontal">
			<osu-profile profile="[[overall_item.user.osu_profile]]" sub_since="[[overall_item.user.twitch_profile.sub_since]]"></osu-profile>
			<div class="layout vertical" style="margin-left:20px;">
				<div class="flex"></div>
				<div style="font-size:30px;">[[overall_item.score]]</div>
				<div class="flex"></div>
			</div>
			<div class="layout vertical" style="margin-left:20px;">
				<div class="flex"></div>
				<paper-dropdown-menu label="Moves on to" disabled>
					<paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{overall_item.continues}}">
						<paper-item value="Continues">Continues</paper-item>
						<paper-item value="Drops down">Drops down</paper-item>
						<paper-item value="Eliminated">Eliminated</paper-item>
					</paper-listbox>
				</paper-dropdown-menu>
				<div class="flex"></div>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'overall-item',
			properties: {
				overall_item: Object
			},
			ready: function() {
				
			}
		});
	</script>
</dom-module>

<dom-module id="game-item">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning"></style>
		<div class="layout vertical">
			<div class="layout horizontal" style="margin:20px;">
				<mappool-item beatmap-id="[[game_item.beatmap_id]]" map="[[game_item.beatmap]]" mods="[[game_item.mods]]" freemod="[[game_item.freemod]]" tiebreaker="[[game_item.tiebreaker]]"></mappool-item>
				<div class="layout vertical" style="margin-left:20px;">
					<div class="flex"></div>
					<paper-dropdown-menu label="Picked by" disabled>
						<paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{picked_by}}">
							<template is="dom-repeat" items="[[players]]">
								<paper-item value="[[item.user.discord_profile.id]]">[[item.user.osu_profile.username]]</paper-item>
							</template>
						</paper-listbox>
					</paper-dropdown-menu>
					<div class="flex"></div>
				</div>
			</div>
			<template is="dom-repeat" items="[[game_item.scores]]">
				<div class="layout horizontal" style="width:900px;margin-bottom:10px;">
					<div class="flex"></div>
					<score-item user-id="[[item.user_id]]" profile="[[item.osu_profile]]" score="[[item.score]]" combo="[[item.maxcombo]]" pass-setter="[[item.pass]]" count300="[[item.count300]]" count100="[[item.count100]]" count50="[[item.count50]]" countmiss="[[item.countmiss]]" points="[[item.points]]"></score-item>
				</div>
			</template>
		</div>
	</template>
	<script>
		Polymer({
			is: 'game-item',
			properties: {
				game_item: {
					type: Object,
					observer: 'game_itemChanged'
				},
				counts: {
					type: Boolean,
					value: false
				},
				locked: {
					type: Boolean,
					value: false
				},
				picked_by: String
			},
			game_itemChanged: function() {
				this.locked = true;
				this.counts = this.game_item.counts == '1';
				if (this.game_item.picked_by) {
					this.picked_by = this.game_item.picked_by;
				}
				this.locked = false;
			}
		});
	</script>
</dom-module>

<dom-module id="score-item">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning"></style>
		<div class="layout horizontal">
			<paper-card elevation="1" class="layout vertical" style="height:64px;width:500px;background-color:#212121;">
				<div class="card-content" style="height:64px;width:500px;padding:0;">
					<div class="layout horizontal">
						<img src="https://a.ppy.sh/[[userId]]" style="height:64px;width:64px;">
						<div class="flex layout vertical" style="margin-left:10px;color:white;">
							<div style="font-size:30px;">[[profile.username]]</div>
							<div>Score: <span>[[score]]</span> (<span>[[combo]]</span>x)</div>
						</div>
						<div class="layout vertical" style="width:64px;color:red;">
							<div hidden$="[[pass]]">FAILED</div>
						</div>
						<div class="layout vertical" style="width:64px;color:white;text-align:right;">
							<div><span>[[accuracy]]</span>%</div>
						</div>
					</div>
				</div>
			</paper-card>
			<div class="layout vertical" style="margin-left:10px;width:50px;">
				<div class="flex"></div>
				<div style="font-size:30px;">[[points]]</div>
				<div class="flex"></div>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'score-item',
			properties: {
				userId: Number,
				profile: Object,
				score: Number,
				combo: Number,
				accuracy: String,
				pass: {
					type: Boolean,
					value: false
				},
				passSetter: {
					type: String,
					observer: 'passChanged'
				},
				points: Number,
				count300: {
					type: Number,
					observer: 'calculateAccuracy'
				},
				count100: {
					type: Number,
					observer: 'calculateAccuracy'
				},
				count50: {
					type: Number,
					observer: 'calculateAccuracy'
				},
				countmiss: {
					type: Number,
					observer: 'calculateAccuracy'
				}
			},
			passChanged: function() {
				this.pass = this.passSetter == '1';
			},
			calculateAccuracy: function() {
				if ((this.count300 || this.count300 == 0) && (this.count100 || this.count100 == 0) && (this.count50 || this.count50 == 0) && (this.countmiss || this.countmiss == 0)) {
					var totalPointsOfHits = parseInt(this.count50) * 50 + parseInt(this.count100) * 100 + parseInt(this.count300) * 300;
	        var totalNumberOfHits = parseInt(this.countmiss) + parseInt(this.count50) + parseInt(this.count100) + parseInt(this.count300);
	        this.accuracy = Math.round(((totalPointsOfHits / (totalNumberOfHits * 300)) * 100) * 100) / 100;
	      }
			}
		})
	</script>
</dom-module>