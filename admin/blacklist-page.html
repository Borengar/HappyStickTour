<dom-module id="blacklist-page">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning">
			osu-profile {
				margin: 10px;
			}
			.search-button {
				background-color: var(--happystick-green);
				color: white;
				margin-top: 15px;
				margin-left: 20px;
				height: 35px;
			}
			.heading {
				margin: 20px;
				font-size: 40px;
				color: var(--happystick-green);
			}
			.search-bar {
				margin: 20px;
			}
			.add-button {
				background-color: var(--happystick-green);
				margin: 10px;
				width: 400px;
				color: white;
			}
		</style>
		<iron-ajax id="blacklistAjax" url="../api/blacklist" method="GET" last-response="{{blacklist}}"></iron-ajax>
		<iron-ajax id="osuProfileAjax" url="../api/osu_profile/" method="GET" on-response="osuProfileResponse"></iron-ajax>
		<iron-ajax id="addAjax" url="../api/blacklist" method="POST" on-response="addResponse" content-type="application/json"></iron-ajax>
		<iron-ajax id="deleteAjax" url="../api/blacklist/" method="DELETE" on-response="deleteResponse"></iron-ajax>
		<div class="layout vertical">
			<div class="layout horizontal search-bar">
				<paper-input class="search-input" label="osu! ID or Username" value="{{osu_id}}" on-keydown="osuIdKeydown"></paper-input>
				<paper-button class="search-button" raised on-click="searchOsuProfile">Search</paper-button>
			</div>
			<osu-profile profile="[[osu_profile]]"></osu-profile>
			<paper-button class="add-button" raised on-click="add" disabled$="[[add_disabled]]">Add</paper-button>
			<div class="heading">Blacklist</div>
			<template is="dom-repeat" items="[[blacklist]]" as="profile">
				<osu-profile profile="[[profile]]" on-click="showDelete"></osu-profile>
			</template>
		</div>
		<paper-dialog id="deleteDialog" modal>
			<h2>Remove from blacklist</h2>
			<div>Do you want to remove <span>[[remove_username]]</span> from the blacklist?</div>
			<div class="buttons">
				<paper-button dialog-dismiss>Cancel</paper-button>
				<paper-button dialog-confirm style="color:red;" on-click="delete">Remove</paper-button>
			</div>
		</paper-dialog>
		<paper-toast id="successToast" text="[[toast_message]]" style="background-color:#65B309;color:white;"></paper-toast>
		<paper-toast id="errorToast" text="[[toast_message]]" style="background-color:#d32f2f;color:white;"></paper-toast>
	</template>
	<script>
		Polymer({
			is: 'blacklist-page',
			properties: {
				add_disabled: {
					type: Boolean,
					value: true
				}
			},
			ready: function() {
				this.$.blacklistAjax.headers = {
					'Authorization': localStorage.getItem('token')
				};
				this.$.blacklistAjax.generateRequest();
			},
			showDelete: function(e) {
				this.remove_id = e.model.profile.user_id;
				this.remove_username = e.model.profile.username;
				this.$.deleteDialog.open();
			},
			delete: function() {
				this.$.deleteAjax.url = '../api/blacklist/' + this.remove_id;
				this.$.deleteAjax.headers = {
					'Authorization': localStorage.getItem('token')
				};
				this.$.deleteAjax.generateRequest();
			},
			deleteResponse: function(e) {
				var response = e.detail.response;
				this.toast_message = response.message;
				if (response.error == '1') {
					this.$.errorToast.open();
				} else {
					this.$.successToast.open();
				}
				this.$.blacklistAjax.generateRequest();
			},
			osuIdKeydown: function(e) {
				if (e.keyCode == 13) {
					this.searchOsuProfile();
				}
			},
			searchOsuProfile: function() {
				if (this.osu_id) {
					this.$.osuProfileAjax.url = '../api/osu_profile/' + this.osu_id;
					this.$.osuProfileAjax.headers = {
						'Authorization': localStorage.getItem('token')
					};
					this.$.osuProfileAjax.generateRequest();
				}
			},
			osuProfileResponse: function(e) {
				var profile = e.detail.response;
				if (profile && profile.user_id) {
					this.osu_profile = profile;
					this.add_disabled = false;
				} else {
					this.add_disabled = true;
				}
			},
			add: function() {
				if (!this.osu_profile) return;
				this.$.addAjax.headers = {
					'Authorization': localStorage.getItem('token')
				};
				this.$.addAjax.body = {
					'id': this.osu_profile.user_id
				};
				this.$.addAjax.generateRequest();
			},
			addResponse: function(e) {
				var response = e.detail.response;
				this.toast_message = response.message;
				if (response.error == '1') {
					this.$.errorToast.open();
				} else {
					this.$.successToast.open();
				}
				this.$.blacklistAjax.generateRequest();
			}
		});
	</script>
</dom-module>