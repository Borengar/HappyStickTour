<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="lobbies-page">
	<template>
		<style include="iron-flex iron-flex-alignment">
			.wrapper {
				margin: 10px;
			}
			.filter-wrapper {
				flex-shrink: 0;
			}
			.action-button {
				background-color: var(--happystick-green);
				color: white;
				margin: 10px;
				width: 300px;
				flex-shrink: 0;
			}
			.players-wrapper {
				width: 500px;
				min-width: 500px;
				overflow-y: scroll;
			}
			.player-wrapper {
				margin: 10px;
				flex-shrink: 0;
			}
			.availability-wrapper {
				margin: 5px;
				flex-shrink: 0;
			}
			.lobbies-wrapper {
				overflow-y: scroll;
			}
			.lobby-wrapper {
				width: 450px;
				margin: 10px;
			}
			.player-drop-wrapper {
				margin: 10px auto;
				width: 400px;
			}
			.player-empty {
				height: 100px;
				flex-shrink: 0;
				background-color: #090909;
				color: white;
			}
			paper-dropdown-menu {
				margin: 10px;
			}
			#errorToast {
				--paper-toast-background-color: var(--error-red);
			}
		</style>
		<iron-ajax id="roundsAjax" url="../api/rounds" method="GET" last-response="{{rounds}}" auto></iron-ajax>
		<iron-ajax id="tiersAjax" url="../api/tiers" method="GET" last-response="{{tiers}}" auto></iron-ajax>
		<iron-ajax id="getLobbiesAjax" url="../api/lobbies" method="GET" content-type="application/json" last-response="{{lobbies}}" on-response="_getLobbiesResponse"></iron-ajax>
		<iron-ajax id="putLobbiesAjax" url="../api/lobbies" method="PUT" content-type="application/json" on-response="_putLobbiesResponse"></iron-ajax>
		<iron-ajax id="postLobbiesAjax" url="../api/lobbies" method="POST" content-type="application/json" on-response="_postLobbiesResponse"></iron-ajax>
		<iron-ajax id="getPlayersAjax" url="../api/players" method="GET" content-type="application/json" last-response="{{players}}" on-response="_getPlayersResponse"></iron-ajax>
		<div class="wrapper flex layout vertical">
			<div class="filter-wrapper layout horizontal">
				<paper-dropdown-menu label="Round">
					<paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{selectedRound}}">
						<template is="dom-repeat" items="[[rounds]]" as="round">
							<paper-item value="[[round.id]]">[[round.name]]</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
				<paper-dropdown-menu label="Tier">
					<paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{selectedTier}}">
						<template is="dom-repeat" items="[[tiers]]" as="tier">
							<paper-item value="[[tier.id]]">[[tier.name]]</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
			</div>
			<div class="layout horizontal">
				<paper-button class="action-button" on-click="_createLobbies" hidden$="[[!createVisible]]">Create lobbies</paper-button>
				<paper-button class="action-button" on-click="_saveLobbies" hidden$="[[!saveVisible]]">Save lobbies</paper-button>
				<paper-button class="action-button" on-click="_deleteLobbies" hidden$="[[!deleteVisible]]">Delete lobbies</paper-button>
			</div>
			<div class="flex layout horizontal">
				<div class="lobbies-wrapper layout horizontal wrap">
					<template is="dom-repeat" items="{{lobbies}}" as="lobby" mutable-data>
						<div class="lobby-wrapper layout vertical">
							<div>Lobby <span>[[lobby.id]]</span></div>
							<paper-input label="Match time" value="{{lobby.matchTime}}"></paper-input>
							<template is="dom-repeat" items="[[lobby.slots]]" as="slot">
								<div hidden$="[[!slot.userId]]">
									<div class="player-drop-wrapper layout vertical">
										<osu-profile avatar-url="[[slot.osuAvatarUrl]]" username="[[slot.osuUsername]]" pp="[[slot.osuPp]]" hit-accuracy="[[slot.osuHitAccuracy]]" play-count="[[slot.osuPlayCount]]" level="[[slot.osuLevel]]" rank="[[slot.osuRank]]" draggable="true" on-dragover="_dragOver" on-drop="_dropOnPlayer" on-dragstart="_dragFromLobbies"></osu-profile>
										<template is="dom-repeat" items="[[slot.availabilities]]" as="availability">
											<div class="availability-wrapper">
												<div><span>[[availability.timeFrom]]</span> - <span>[[availability.timeTo]]</span></div>
											</div>
										</template>
									</div>
								</div>
								<div hidden$="[[slot.userId]]">
									<div class="player-drop-wrapper layout vertical" on-dragover="_dragOver" on-drop="_dropOnEmpty">
										<div class="player-empty layout horizontal">
											<div class="flex"></div>
											<div class="layout vertical">
												<div class="flex"></div>
												<div>EMPTY</div>
												<div class="flex"></div>
											</div>
											<div class="flex"></div>
										</div>
									</div>
								</div>
							</template>
						</div>
					</template>
				</div>
				<div class="players-wrapper layout vertical" on-dragover="_dragOver" on-drop="_dropOnList">
					<template is="dom-repeat" items="[[players]]" as="player">
						<div class="player-wrapper layout vertical">
							<osu-profile avatar-url="[[player.osuAvatarUrl]]" username="[[player.osuUsername]]" pp="[[player.osuPp]]" hit-accuracy="[[player.osuHitAccuracy]]" play-count="[[player.osuPlayCount]]" level="[[player.osuLevel]]" rank="[[player.osuRank]]" draggable="true" on-dragstart="_dragFromPlayers"></osu-profile>
							<template is="dom-repeat" items="[[player.availabilities]]" as="availability">
								<div class="availability-wrapper">
									<div><span>[[availability.timeFrom]]</span> - <span>[[availability.timeTo]]</span></div>
								</div>
							</template>
						</div>
					</template>
				</div>
			</div>
		</div>
		<paper-toast id="successToast" text="[[message]]"></paper-toast>
		<paper-toast id="errorToast" text="[[message]]"></paper-toast>
	</template>
	<script>
		class LobbiesPage extends Polymer.Element {
			static get is() { return 'lobbies-page' }

			static get properties() {
				return {
					createVisible: {
						type: Boolean,
						value: false
					},
					deleteVisible: {
						type: Boolean,
						value: false
					},
					saveVisible: {
						type: Boolean,
						value: false
					},
					selectedRound: {
						observer: '_getLobbies'
					},
					selectedTier: {
						observer: '_getLobbies'
					}
				}
			}

			_getLobbies() {
				if (this.selectedRound && this.selectedTier) {
					this.set('lobbies', []);
					this.set('players', []);
					this.$.getLobbiesAjax.url = '../api/lobbies/' + this.selectedRound + '/' + this.selectedTier
					this.$.getLobbiesAjax.headers = {
						'Authorization': localStorage.getItem('token')
					}
					this.$.getLobbiesAjax.generateRequest();
				}
			}

			_getLobbiesResponse(e) {
				if (this.lobbies.length == 0) {
					this.createVisible = true;
					this.saveVisible = false;
					this.deleteVisible = false;
				} else {
					this.createVisible = false;
					this.saveVisible = true;
					this.deleteVisible = true;
					this.$.getPlayersAjax.url = '../api/players/' + this.selectedRound + '/' + this.selectedTier
					this.$.getPlayersAjax.headers = {
						'Authorization': localStorage.getItem('token')
					}
					this.$.getPlayersAjax.generateRequest();
				}
			}

			_getPlayersResponse() {
				for (var lobby = 0; lobby < this.lobbies.length; lobby++) {
					for (var slot = 0; slot < this.lobbies[lobby].slots.length; slot++) {
						if (this.lobbies[lobby].slots[slot].userId) {
							for (var player = 0; player < this.players.length; player++) {
								if (this.lobbies[lobby].slots[slot].userId == this.players[player].userId) {
									this.splice('players', player, 1);
								}
							}
						}
					}
				}
			}

			_createLobbies() {
				this.$.postLobbiesAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.postLobbiesAjax.body = {
					'round': this.selectedRound,
					'tier': this.selectedTier
				}
				this.$.postLobbiesAjax.generateRequest();
			}

			_postLobbiesResponse(e) {
				var response = e.detail.response;
				this.message = response.message;
				if (response.error == '1') {
					this.$.errorToast.open();
				} else {
					this.$.successToast.open();
					this.$.getLobbiesAjax.generateRequest();
				}
			}

			_saveLobbies() {
				this.$.putLobbiesAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.putLobbiesAjax.body = {
					'lobbies': this.lobbies
				}
				this.$.putLobbiesAjax.generateRequest();
			}

			_putLobbiesResponse(e) {
				var response = e.detail.response;
				this.message = response.message;
				if (response.error == '1') {
					this.$.errorToast.open();
				} else {
					this.$.successToast.open();
				}
			}

			_dragOver(e) {
				e.preventDefault();
			}

			_dropOnEmpty(e) {
				if (this.dragFromPlayers) {
					lobby_loop:
					for (var lobby = 0; lobby < this.lobbies.length; lobby++) {
						for (var slot = 0; slot < this.lobbies[lobby].slots.length; slot++) {
							if (this.lobbies[lobby].slots[slot].id == e.model.slot.id) {
								this.set('lobbies.' + lobby + '.slots.' + slot + '.availabilities', this.dragObject.availabilities);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuAvatarUrl', this.dragObject.osuAvatarUrl);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuHitAccuracy', this.dragObject.osuHitAccuracy);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuId', this.dragObject.osuId);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuLevel', this.dragObject.osuLevel);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPlayCount', this.dragObject.osuPlayCount);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPp', this.dragObject.osuPp);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuRank', this.dragObject.osuRank);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuUsername', this.dragObject.osuUsername);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.userId', this.dragObject.userId);
								break lobby_loop;
							}
						}
					}
					for (var player = 0; player < this.players.length; player++) {
						if (this.players[player].userId == this.dragObject.userId) {
							this.splice('players', player, 1);
							break;
						}
					}
				} else if (this.dragFromLobbies) {
					for (var lobby = 0; lobby < this.lobbies.length; lobby++) {
						for (var slot = 0; slot < this.lobbies[lobby].slots.length; slot++) {
							if (this.lobbies[lobby].slots[slot].userId == this.dragObject.userId) {
								this.set('lobbies.' + lobby + '.slots.' + slot + '.availabilities', []);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuAvatarUrl', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuHitAccuracy', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuId', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuLevel', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPlayCount', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPp', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuRank', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuUsername', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.userId', null);
							}
						}
					}
					lobby_loop:
					for (var lobby = 0; lobby < this.lobbies.length; lobby++) {
						for (var slot = 0; slot < this.lobbies[lobby].slots.length; slot++) {
							if (this.lobbies[lobby].slots[slot].id == e.model.slot.id) {
								this.set('lobbies.' + lobby + '.slots.' + slot + '.availabilities', this.dragObject.availabilities);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuAvatarUrl', this.dragObject.osuAvatarUrl);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuHitAccuracy', this.dragObject.osuHitAccuracy);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuId', this.dragObject.osuId);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuLevel', this.dragObject.osuLevel);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPlayCount', this.dragObject.osuPlayCount);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPp', this.dragObject.osuPp);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuRank', this.dragObject.osuRank);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuUsername', this.dragObject.osuUsername);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.userId', this.dragObject.userId);
								break lobby_loop;
							}
						}
					}
				}
			}

			_dropOnList(e) {
				if (this.dragFromLobbies) {
					this.push('players', this.dragObject);
					for (var lobby = 0; lobby < this.lobbies.length; lobby++) {
						for (var slot = 0; slot < this.lobbies[lobby].slots.length; slot++) {
							if (this.lobbies[lobby].slots[slot].userId == this.dragObject.userId) {
								this.set('lobbies.' + lobby + '.slots.' + slot + '.availabilities', []);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuAvatarUrl', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuHitAccuracy', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuId', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuLevel', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPlayCount', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPp', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuRank', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuUsername', null);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.userId', null);
							}
						}
					}
				}
			}

			_dropOnPlayer(e) {
				if (this.dragFromPlayers) {
					for (var player = 0; player < this.players.length; player++) {
						if (this.players[player].userId == this.dragObject.userId) {
							this.splice('players', player, 1);
							break;
						}
					}
					this.push('players', {
						availabilities: e.model.slot.availabilities,
						osuAvatarUrl: e.model.slot.osuAvatarUrl,
						osuHitAccuracy: e.model.slot.osuHitAccuracy,
						osuId: e.model.slot.osuId,
						osuLevel: e.model.slot.osuLevel,
						osuPlayCount: e.model.slot.osuPlayCount,
						osuPp: e.model.slot.osuPp,
						osuRank: e.model.slot.osuRank,
						osuUsername: e.model.slot.osuUsername,
						userId: e.model.slot.userId
					});
					lobby_loop:
					for (var lobby = 0; lobby < this.lobbies.length; lobby++) {
						for (var slot = 0; slot < this.lobbies[lobby].slots.length; slot++) {
							if (this.lobbies[lobby].slots[slot].id == e.model.slot.id) {
								this.set('lobbies.' + lobby + '.slots.' + slot + '.availabilities', this.dragObject.availabilities);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuAvatarUrl', this.dragObject.osuAvatarUrl);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuHitAccuracy', this.dragObject.osuHitAccuracy);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuId', this.dragObject.osuId);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuLevel', this.dragObject.osuLevel);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPlayCount', this.dragObject.osuPlayCount);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPp', this.dragObject.osuPp);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuRank', this.dragObject.osuRank);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuUsername', this.dragObject.osuUsername);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.userId', this.dragObject.userId);
								break lobby_loop;
							}
						}
					}
				} else if (this.dragFromLobbies) {
					lobby_loop:
					for (var lobby = 0; lobby < this.lobbies.length; lobby++) {
						for (var slot = 0; slot < this.lobbies[lobby].slots.length; slot++) {
							if (this.lobbies[lobby].slots[slot].id == this.slotId) {
								this.set('lobbies.' + lobby + '.slots.' + slot + '.availabilities', e.model.slot.availabilities);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuAvatarUrl', e.model.slot.osuAvatarUrl);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuHitAccuracy', e.model.slot.osuHitAccuracy);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuId', e.model.slot.osuId);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuLevel', e.model.slot.osuLevel);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPlayCount', e.model.slot.osuPlayCount);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPp', e.model.slot.osuPp);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuRank', e.model.slot.osuRank);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuUsername', e.model.slot.osuUsername);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.userId', e.model.slot.userId);
								break lobby_loop;
							}
						}
					}
					lobby_loop2:
					for (var lobby = 0; lobby < this.lobbies.length; lobby++) {
						for (var slot = 0; slot < this.lobbies[lobby].slots.length; slot++) {
							if (this.lobbies[lobby].slots[slot].id == e.model.slot.id) {
								this.set('lobbies.' + lobby + '.slots.' + slot + '.availabilities', this.dragObject.availabilities);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuAvatarUrl', this.dragObject.osuAvatarUrl);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuHitAccuracy', this.dragObject.osuHitAccuracy);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuId', this.dragObject.osuId);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuLevel', this.dragObject.osuLevel);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPlayCount', this.dragObject.osuPlayCount);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuPp', this.dragObject.osuPp);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuRank', this.dragObject.osuRank);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.osuUsername', this.dragObject.osuUsername);
								this.set('lobbies.' + lobby + '.slots.' + slot + '.userId', this.dragObject.userId);
								break lobby_loop2;
							}
						}
					}
				}
			}

			_dragFromPlayers(e) {
				this.dragFromPlayers = true;
				this.dragFromLobbies = false;
				this.dragObject = {
					availabilities: e.model.player.availabilities,
					osuAvatarUrl: e.model.player.osuAvatarUrl,
					osuHitAccuracy: e.model.player.osuHitAccuracy,
					osuId: e.model.player.osuId,
					osuLevel: e.model.player.osuLevel,
					osuPlayCount: e.model.player.osuPlayCount,
					osuPp: e.model.player.osuPp,
					osuRank: e.model.player.osuRank,
					osuUsername: e.model.player.osuUsername,
					userId: e.model.player.userId
				}
			}

			_dragFromLobbies(e) {
				this.slotId = e.model.slot.id;
				this.dragFromPlayers = false;
				this.dragFromLobbies = true;
				this.dragObject = {
					availabilities: e.model.slot.availabilities,
					osuAvatarUrl: e.model.slot.osuAvatarUrl,
					osuHitAccuracy: e.model.slot.osuHitAccuracy,
					osuId: e.model.slot.osuId,
					osuLevel: e.model.slot.osuLevel,
					osuPlayCount: e.model.slot.osuPlayCount,
					osuPp: e.model.slot.osuPp,
					osuRank: e.model.slot.osuRank,
					osuUsername: e.model.slot.osuUsername,
					userId: e.model.slot.userId
				}
			}
		}

		window.customElements.define(LobbiesPage.is, LobbiesPage);
	</script>
</dom-module>