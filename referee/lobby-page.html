<link rel="import" href="../bower_components/polymer/polymer-element.html">

<dom-module id="lobby-page">
	<template>
		<style include="iron-flex iron-flex-alignment quill-core quill-snow">
			.wrapper {
				margin: 10px;
			}
			paper-input {
				--paper-input-container-focus-color: var(--happystick-green);
			}
			.id-input {
				width: 200px;
			}
			.action-button {
				background-color: var(--happystick-green);
				color: white;
				margin: 10px;
				flex-shrink: 0;
			}
			.refresh-button {
				width: 200px;
			}
			match-game {
				margin-top: 20px;
				margin-bottom: 20px;
			}
			.counts {
				margin-left: 10px;
				margin-top: 50px;
			}
			.picked-by {
				margin-left: 10px;
			}
			#errorToast {
				--paper-toast-background-color: var(--error-red);
			}
			.overall-wrapper {
				margin: 5px;
			}
			.overall-score {
				margin-left: 5px;
				font-size: 30px;
			}
			paper-tabs {
				--paper-tabs-selection-bar-color: var(--happystick-green);
				background-color: var(--discord-grey);
				color: white;
			}
			.player-wrapper {
				margin: 5px;
			}
			.player-invite {
				margin-left: 5px;
				font-size: 20px;
			}
			.player-continues {
				margin-top: 10px;
				margin-left: 5px;
			}
			beatmap-info {
				margin: 10px;
				flex-shrink: 0;
			}
			.command-frame {
				width: 1000px;
			}
			.command {
				margin: 5px;
				color: var(--happystick-green);
			}
			.explanation {
				color: #000000;
			}
			.save-continue-button {
				width: 300px;
			}
			.ql-toolbar, #editor {
				max-width: 1000px;
				margin-left: 10px;
			}
			.ql-toolbar {
				margin-top: 30px;
			}
			#editor {
				height: 400px;
			}
			.save-comment-button {
				width: 300px;
			}
		</style>
		<iron-ajax id="putLobbyAjax" url="../api/lobbies/" method="PUT" content-type="application/json" on-response="_putLobbyResponse"></iron-ajax>
		<iron-ajax id="getMatchAjax" url="../api/osumatch/" method="GET" last-response="{{matchHistory}}" on-response="_getMatchResponse"></iron-ajax>
		<iron-ajax id="putGameAjax" url="../api/osugame/" method="PUT" content-type="application/json" on-response="_putGameResponse"></iron-ajax>
		<iron-ajax id="postGameAjax" url="../api/osumatch//games" method="POST" content-type="application/json" on-response="_postGameResponse"></iron-ajax>
		<iron-ajax id="deleteGameAjax" url="../api/osugame/" method="DELETE" on-response="_deleteGameResponse"></iron-ajax>
		<iron-ajax id="getMappoolAjax" url="../api/mappools/" method="GET" last-response="{{mappool}}"></iron-ajax>
		<div class="flex layout vertical">
			<paper-tabs selected="{{tabSelected}}" attr-for-selected="value">
				<paper-tab value="match">MATCH</paper-tab>
				<paper-tab value="players">PLAYERS</paper-tab>
				<paper-tab value="mappool">MAPPOOL</paper-tab>
				<paper-tab value="commands">REF COMMANDS</paper-tab>
			</paper-tabs>
			<iron-pages selected="[[tabSelected]]" attr-for-selected="value">
				<div class="wrapper flex layout vertical" value="match">
					<div class="layout horizontal">
						<paper-input class="id-input" label="Match ID" value="{{lobby.matchId}}"></paper-input>
						<paper-button class="action-button" raised on-click="_matchIdChanged">Change</paper-button>
					</div>
					<paper-button class="action-button refresh-button" raised on-click="_loadMatch">Refresh</paper-button>
					<template is="dom-repeat" items="{{matchHistory}}">
						<template is="dom-if" if="[[_isMatchCreated(item.type)]]">
							<div><span>[[_convertTimestamp(item.timestamp)]]</span> Match created</div>
						</template>
						<template is="dom-if" if="[[_isPlayerJoined(item.type)]]">
							<div><span>[[_convertTimestamp(item.timestamp)]]</span> <span>[[item.player.username]]</span> joined the match</div>
						</template>
						<template is="dom-if" if="[[_isOther(item.type)]]">
							<div class="layout horizontal">
								<div class="layout vertical">
									<match-game game="[[item.game]]"></match-game>
									<template is="dom-if" if="[[lobby.hasBracketReset]]">
										<paper-button class="action-button" raised on-click="_insertBracketReset">Insert Bracket Reset</paper-button>
									</template>
								</div>
								<div class="layout vertical">
									<paper-toggle-button class="counts" checked="[[_counts(item.game.counts)]]" on-checked-changed="_countsChanged">Counts</paper-toggle-button>
									<vaadin-combo-box class="picked-by" label="Picked by" items="[[players]]" value="{{item.game.picked_by}}" item-value-path="userId" item-label-path="osuUsername" on-change="_pickedByChanged"></vaadin-combo-box>
								</div>
							</div>
						</template>
						<template is="dom-if" if="[[_isPlayerLeft(item.type)]]">
							<div><span>[[_convertTimestamp(item.timestamp)]]</span> <span>[[item.player.username]]</span> left the match</div>
						</template>
						<template is="dom-if" if="[[_isMatchDisbanded(item.type)]]">
							<div><span>[[_convertTimestamp(item.timestamp)]]</span> Match disbanded</div>
						</template>
						<template is="dom-if" if="[[_isBracketReset(item.type)]]">
							<div class="layout horizontal">
								<div class="layout vertical">
									<div class="flex"></div>
									<div><span>[[_convertTimestamp(item.timestamp)]]</span> Bracket Reset</div>
									<div class="flex"></div>
								</div>
								<paper-button class="action-button" raised on-click="_deleteBracketReset">Remove</paper-button>
							</div>
						</template>
						<template is="dom-if" if="[[_isOverall(item.type)]]">
							<template is="dom-repeat" items="[[item.slots]]" as="slot">
								<div class="overall-wrapper layout horizontal">
									<osu-profile avatar-url="[[slot.osuAvatarUrl]]" username="[[slot.osuUsername]]" pp="[[slot.osuPp]]" hit-accuracy="[[slot.osuHitAccuracy]]" play-count="[[slot.osuPlayCount]]" level="[[slot.osuLevel]]" rank="[[slot.osuRank]]"></osu-profile>
									<div class="layout vertical">
										<div class="flex"></div>
										<div class="overall-score">[[slot.score]]</div>
										<div class="flex"></div>
									</div>
								</div>
							</template>
						</template>
					</template>
				</div>
				<div class="wrapper flex layout vertical" value="players">
					<template is="dom-repeat" items="{{lobby.slots}}" as="slot">
						<template is="dom-if" if="[[slot.osuId]]">
							<div class="player-wrapper layout horizontal">
								<osu-profile avatar-url="[[slot.osuAvatarUrl]]" username="[[slot.osuUsername]]" pp="[[slot.osuPp]]" hit-accuracy="[[slot.osuHitAccuracy]]" play-count="[[slot.osuPlayCount]]" level="[[slot.osuLevel]]" rank="[[slot.osuRank]]"></osu-profile>
								<div class="layout vertical">
									<div class="player-invite">!mp invite #[[slot.osuId]]</div>
									<vaadin-combo-box class="player-continues" label="Continues" items='["Continue","Drop down","Eliminated","Forfeit","Noshow"]' value="{{slot.continue}}"></vaadin-combo-box>
								</div>
							</div>
						</template>
					</template>
					<paper-button class="action-button save-continue-button" raised on-click="_saveContinues">Save</paper-button>
					<div id="editor"></div>
					<paper-button class="action-button save-comment-button" raised on-click="_saveComment">Save</paper-button>
				</div>
				<div class="wrapper flex layout vertical" value="mappool">
					<template is="dom-repeat" items="[[mappool.slots]]" as="beatmap">
						<beatmap-info accuracy="[[beatmap.accuracy]]" ar="[[beatmap.ar]]" artist="[[beatmap.artist]]" beatmap-id="[[beatmap.beatmapId]]" beatmapset-id="[[beatmap.beatmapsetId]]" bpm="[[beatmap.bpm]]" count-circles="[[beatmap.countCircles]]" count-sliders="[[beatmap.countSliders]]" cover="[[beatmap.cover]]" cs="[[beatmap.cs]]" difficulty-rating="[[beatmap.difficultyRating]]" drain="[[beatmap.drain]]" preview-url="[[beatmap.previewUrl]]" title="[[beatmap.title]]" total-length="[[beatmap.totalLength]]" version="[[beatmap.version]]" mod="[[beatmap.mod]]"></beatmap-info>
					</template>
				</div>
				<div class="wrapper flex layout vertical" value="commands">
					<div class="command">!mp make &lt;name&gt; <span class="explanation">Creates a tournament room</span></div>
					<div class="command">!mp close <span class="explanation">Closes the room</span></div>
					<div class="command">!mp invite &lt;username&gt; <span class="explanation">Invites a player to the room</span></div>
					<div class="command">!mp kick &lt;username&gt; <span class="explanation">Kicks a player from the room</span></div>
					<div class="command">!mp lock/unlock <span class="explanation">Locks/Unlocks a room so players can't change their slot</span></div>
					<div class="command">!mp size &lt;size&gt; <span class="explanation">Sets the amount of available slots</span></div>
					<div class="command">!mp host &lt;username&gt; <span class="explanation">Gives a player host</span></div>
					<div class="command">!mp clearhost <span class="explanation">Resets host</span></div>
					<div class="command">!mp settings <span class="explanation">Displays room details</span></div>
					<div class="command">!mp start &lt;time&gt; <span class="explanation">Starts the match after &lt;time&gt; seconds</span></div>
					<div class="command">!mp timer &lt;time&gt; <span class="explanation">Starts a countdown timer</span></div>
					<div class="command">!mp aborttimer <span class="explanation">Stops the current timer (timer or start)</span></div>
					<div class="command">!mp abort <span class="explanation">Aborts the match</span></div>
					<div class="command">!mp map &lt;beatmap id&gt; <span class="explanation">Changes the beatmap</span></div>
					<div class="command">!mp mods &lt;name&gt; <span class="explanation">Changes the mods</span></div>
				</div>
			</iron-pages>
		</div>
		<paper-toast id="successToast" text="[[message]]"></paper-toast>
		<paper-toast id="errorToast" text="[[message]]"></paper-toast>
	</template>
	<script>
		class LobbyPage extends Polymer.Element {
			static get is() { return 'lobby-page' }

			static get properties() {
				return {
					lobby: {
						observer: '_lobbyChanged'
					}
				}
			}

			ready() {
				super.ready();
				this.tabSelected = 'match';
				this.$.getMappoolAjax.url = '../api/mappools/' + this.lobby.round + '/' + this.lobby.tier;
				this.$.getMappoolAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.getMappoolAjax.generateRequest();
				this.editor = new Quill(this.$.editor, {
					theme: 'snow',
					placeholder: 'Ref comments'
				});
				this.editor.setContents(JSON.parse(this.lobby.comment));
			}

			_lobbyChanged(e) {
				this.players = [];
				for (var i = 0; i < this.lobby.slots.length; i++) {
					if (this.lobby.slots[i].userId) {
						if (this.lobby.slots[i].continueToUpper == '1') {
							this.set('lobby.slots.' + i + '.continue', 'Continue');
						} else if (this.lobby.slots[i].dropDown == '1') {
							this.set('lobby.slots.' + i + '.continue', 'Drop down');
						} else if (this.lobby.slots[i].eliminated == '1') {
							this.set('lobby.slots.' + i + '.continue', 'Eliminated');
						} else if (this.lobby.slots[i].forfeit == '1') {
							this.set('lobby.slots.' + i + '.continue', 'Forfeit');
						} else if (this.lobby.slots[i].noshow == '1') {
							this.set('lobby.slots.' + i + '.continue', 'Noshow');
						} else {
							this.set('lobby.slots.' + i + '.continue', null);
						}
						this.push('players', this.lobby.slots[i]);
					}
				}
			}

			_matchIdChanged() {
				this.$.putLobbyAjax.url = '../api/lobbies/' + this.lobby.id;
				this.$.putLobbyAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.putLobbyAjax.body = {
					'matchId': this.lobby.matchId
				}
				this.$.putLobbyAjax.generateRequest();
			}

			_loadMatch() {
				this.$.getMatchAjax.url = '../api/osumatch/' + this.lobby.matchId;
				this.$.getMatchAjax.generateRequest();
			}

			_getMatchResponse(e) {
				var overall = [];
				for (var i = 0; i < this.lobby.slots.length; i++) {
					if (this.lobby.slots[i].osuId) {
						overall.push({
							osuAvatarUrl: this.lobby.slots[i].osuAvatarUrl,
							osuHitAccuracy: this.lobby.slots[i].osuHitAccuracy,
							osuId: this.lobby.slots[i].osuId,
							osuLevel: this.lobby.slots[i].osuLevel,
							osuPlayCount: this.lobby.slots[i].osuPlayCount,
							osuPp: this.lobby.slots[i].osuPp,
							osuRank: this.lobby.slots[i].osuRank,
							osuUsername: this.lobby.slots[i].osuUsername,
							score: 0
						});
					}
				}
				for (var i = 0; i < this.matchHistory.length; i++) {
					if (this.matchHistory[i].type == 'other' && this.matchHistory[i].game.counts == '1') {
						if (overall.length == 2) {
							var scoreAmount = 1;
						} else {
							var scoreAmount = 4;
						}
						for (var j = 0; j < this.matchHistory[i].game.scores.length; j++) {
							for (var k = 0; k < overall.length; k++) {
								if (overall[k].osuId == this.matchHistory[i].game.scores[j].userId) {
									overall[k].score += scoreAmount;
									switch (scoreAmount) {
										case 4: scoreAmount = 3; break;
										case 3: scoreAmount = 2; break;
										default: scoreAmount = 0; break;
									}
								}
							}
							if (scoreAmount == 0) {
								break;
							}
						}
					}
					if (this.matchHistory[i].type == 'bracket-reset' || this.matchHistory[i].type == 'match-disbanded') {
						overall.sort((a, b) => {
							return b.score - a.score;
						});
						this.splice('matchHistory', i, 0, {
							type: 'overall',
							slots: overall
						});
						var overall = [];
						for (var j = 0; j < this.lobby.slots.length; j++) {
							if (this.lobby.slots[j].osuId) {
								overall.push({
									osuAvatarUrl: this.lobby.slots[j].osuAvatarUrl,
									osuHitAccuracy: this.lobby.slots[j].osuHitAccuracy,
									osuId: this.lobby.slots[j].osuId,
									osuLevel: this.lobby.slots[j].osuLevel,
									osuPlayCount: this.lobby.slots[j].osuPlayCount,
									osuPp: this.lobby.slots[j].osuPp,
									osuRank: this.lobby.slots[j].osuRank,
									osuUsername: this.lobby.slots[j].osuUsername,
									score: 0
								});
							}
						}
						i++;
					}
				}
			}

			_countsChanged(e) {
				this.$.putGameAjax.url = '../api/osugame/' + e.model.item.id;
				this.$.putGameAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.putGameAjax.body = {
					'counts': e.detail.value
				}
				this.$.putGameAjax.generateRequest();
			}

			_pickedByChanged(e) {
				var item = e.model.item;
				this.$.putGameAjax.url = '../api/osugame/' + item.id;
				this.$.putGameAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.putGameAjax.body = {
					'pickedBy': item.game.picked_by
				}
				this.$.putGameAjax.generateRequest();
			}

			_putGameResponse(e) {
				var response = e.detail.response;
				this.message = response.message;
				if (response.error == '1') {
					this.$.errorToast.open();
				} else {
					this.$.successToast.open();
				}
			}

			_insertBracketReset(e) {
				this.$.postGameAjax.url = '../api/osumatch/' + this.lobby.matchId + '/games';
				this.$.postGameAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.postGameAjax.body = {
					'time': e.model.item.game.end_time
				}
				this.$.postGameAjax.generateRequest();
			}

			_postGameResponse(e) {
				var response = e.detail.response;
				this.message = response.message;
				if (response.error == '1') {
					this.$.errorToast.open();
				} else {
					this.$.successToast.open();
					this.$.getMatchAjax.generateRequest();
				}
			}

			_deleteBracketReset(e) {
				this.$.deleteGameAjax.url = '../api/osugame/' + e.model.item.id;
				this.$.deleteGameAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.deleteGameAjax.generateRequest();
			}

			_deleteGameResponse(e) {
				var response = e.detail.response;
				this.message = response.message;
				if (response.error == '1') {
					this.$.errorToast.open();
				} else {
					this.$.successToast.open();
					this.$.getMatchAjax.generateRequest();
				}
			}

			_saveContinues() {
				for (var i = this.matchHistory.length - 1; i >= 0; i--) {
					if (this.matchHistory[i].type == 'overall') {
						var lastOverall = this.matchHistory[i].slots;
						break;
					}
				}
				this.$.putLobbyAjax.url = '../api/lobbies/' + this.lobby.id;
				this.$.putLobbyAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.putLobbyAjax.body = {
					'continues': this.lobby.slots,
					'overall': lastOverall
				}
				this.$.putLobbyAjax.generateRequest();
			}

			_saveComment() {
				this.$.putLobbyAjax.url = '../api/lobbies/' + this.lobby.id;
				this.$.putLobbyAjax.headers = {
					'Authorization': localStorage.getItem('token')
				}
				this.$.putLobbyAjax.body = {
					'comment': JSON.stringify(this.editor.getContents())
				}
				this.$.putLobbyAjax.generateRequest();
			}

			_putLobbyResponse(e) {
				var response = e.detail.response;
				this.message = response.message;
				if (response.error == '1') {
					this.$.errorToast.open();
				} else {
					this.$.successToast.open();
				}
			}

			_isMatchCreated(e) {
				return e == 'match-created';
			}

			_isPlayerJoined(e) {
				return e == 'player-joined';
			}

			_isOther(e) {
				return e == 'other';
			}

			_isPlayerLeft(e) {
				return e == 'player-left';
			}

			_isMatchDisbanded(e) {
				return e == 'match-disbanded';
			}

			_isBracketReset(e) {
				return e == 'bracket-reset';
			}

			_isOverall(e) {
				return e == 'overall';
			}

			_counts(e) {
				return e == '1';
			}

			_convertTimestamp(e) {
				return e.substring(11, 16);
			}
		}

		window.customElements.define(LobbyPage.is, LobbyPage);
	</script>
</dom-module>