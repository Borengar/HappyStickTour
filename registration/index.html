<!DOCTYPE html>
<html>
	<head>
		<script src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
		<link rel="import" href="../import.html">
		<title>HappyStick Seasonal Tour</title>
		<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning default-colors">
			html {
				font-family: Roboto;
			}
		</style>
	</head>
	<body class="fullbleed layout vertical">
		<index-page class="flex layout vertical"></index-page>
	</body>
</html>

<dom-module id="index-page">
	<template>
		<style is="custom-style" include="iron-flex iron-flex-alignment iron-positioning">
			app-header {
				background-color: var(--discord-grey);
			}
			paper-input {
				--paper-input-container-focus-color: var(--happystick-green);
			}
			osu-profile {
				margin-left: 20px;
				margin-top: 20px;
				display: block;
			}
			twitch-profile {
				margin-left: 20px;
			}
			a {
				color: var(--happystick-green);
			}
			.main-title {
				color: white;
			}
			.logout-button {
				color: white;
				margin-left: 20px;
			}
			.heading {
				margin: 20px;
				font-size: 40px;
				color: var(--happystick-green);
			}
			.search-bar {
				margin: 20px;
				min-height: 40px;
			}
			.search-button {
				background-color: var(--happystick-green);
				color: white;
				margin-top: 15px;
				margin-left: 20px;
				height: 35px;
				display: block;
			}
			.email-input {
				margin: 20px;
				width: 400px;
			}
			.tier-bar {
				margin: 20px;
			}
			.register-button {
				background-color: var(--happystick-green);
				color: white;
				margin: 20px;
				width: 400px;
			}
			.twitch-button {
				background-color: var(--twitch-purple);
				color: white;
				margin: 20px;
				width: 400px;
			}
			.text {
				margin-left: 20px;
			}
			.success {
				font-size: 30px;
				margin: 20px;
				color: var(--happystick-green);
			}
			.unregister-button {
				background-color: var(--error-red);
				color: white;
				margin: 20px;
				width: 400px;
			}
			paper-button[dialog-confirm] {
				color: var(--error-red);
			}
		</style>
		<iron-ajax id="userAjax" url="../api/users/@me" method="GET" on-response="userResponse"></iron-ajax>
		<iron-ajax id="tiersAjax" url="../api/tiers" method="GET" last-response="{{tiers}}"></iron-ajax>
		<iron-ajax id="osuProfileAjax" url="../api/osu_profile/" method="GET" on-response="osuProfileResponse"></iron-ajax>
		<iron-ajax id="registerAjax" url="../api/users/@me" method="PUT" on-response="registerResponse" content-type="application/json"></iron-ajax>
		<app-header>
			<app-toolbar>
				<div main-title class="main-title">Registration</div>
				<div class="flex"></div>
				<discord-profile profile="[[discord_profile]]"></discord-profile>
				<paper-icon-button class="logout-button" icon="power-settings-new" on-click="logout"></paper-icon-button>
			</app-toolbar>
		</app-header>
		<div class="flex layout vertical">
			<div class="heading">HAPPYSTICK SUMMER TOUR REGISTRATION</div>
			<div class="text">Welcome to the HappyStick Summer Tour Registration!</div>
			<div class="text">By going through the previous page you've registered on our site with your Discord account. Input your osu! username below to link your osu! account with our site and to register for the Summer Tour.</div>
			<div class="text">There are a limited amount of slots so the earlier you register, the more likely you'll make it in! You can come back here to check if you've been accepted when the clock strikes July 12th UTC.</div>
			<div class="text">If your registration is accepted you will be automatically assigned the appropriate Discord role on our server.</div>
			<div class="text">For an in-depth look into how the Summer Tour is run take a look at <a href="https://goo.gl/eZrArh" target="_blank">this document.</a> Here you'll find an overview of the prizepool, format, rules, etc.</div>
			<div class="layout horizontal search-bar" hidden$="[[osu_search_hidden]]">
				<paper-input class="search-input" label="osu! ID or Username" value="{{osu_id}}" on-keydown="osuIdKeydown"></paper-input>
				<paper-button class="search-button" raised on-click="searchOsuProfile">Search</paper-button>
			</div>
			<osu-profile profile="[[osu_profile]]" sub_since="[[sub_since]]"></osu-profile>
			<div class="tier-bar" hidden$="[[tier_hidden]]">Your tier: <span>[[tier_name]]</span></div>
			<div class="tier-bar" hidden$="[[no_tier_hidden]]">Sorry, but there is no tier you could register for.</div>
			<paper-button class="register-button" raised on-click="register" disabled$="[[register_disabled]]" hidden$="[[register_hidden]]">Register</paper-button>
			<div class="success" hidden$="[[success_hidden]]">Registration successful!</div>
			<div class="text" hidden$="[[link_twitch_hidden]]">If you've been a currently active HappyStick twitch.tv subscriber for 1-month or longer you'll get preferrential Summer Tour entry by linking your Twitch account below!</div>
			<paper-button class="twitch-button" raised on-click="linkTwitch" hidden$="[[link_twitch_hidden]]">Link Twitch</paper-button>
			<twitch-profile profile="[[twitch_profile]]" hidden$="[[twitch_profile_hidden]]"></twitch-profile>
			<!--<paper-button class="unregister-button" raised on-click="showUnregister" hidden$="[[unregister_hidden]]">Remove registration</paper-button>-->
		</div>
		<paper-dialog id="unregisterDialog" modal>
			<h2>Remove Registration</h2>
			<div>Are you sure you want to remove your registration?</div>
			<div>You can always signup again later, but lose your place in the queue.</div>
			<div class="buttons">
				<paper-button dialog-dismiss>Cancel</paper-button>
				<paper-button dialog-confirm on-click="unregister">Unregister</paper-button>
			</div>
		</paper-dialog>
		<paper-toast id="successToast" text="[[toast_message]]" style="background-color:#65B309;color:white;"></paper-toast>
		<paper-toast id="errorToast" text="[[toast_message]]" style="background-color:#d32f2f;color:white;"></paper-toast>
	</template>
	<script>
		addEventListener('WebComponentsReady', () => {
			Polymer({
				is: 'index-page',
				properties: {
					osu_search_hidden: {
						type: Boolean,
						value: true
					},
					register_disabled: {
						type: Boolean,
						value: true
					},
					tier_hidden: {
						type: Boolean,
						value: true
					},
					register_hidden: {
						type: Boolean,
						value: true
					},
					no_tier_hidden: {
						type: Boolean,
						value: true
					},
					link_twitch_hidden: {
						type: Boolean,
						value: true
					},
					twitch_profile_hidden: {
						type: Boolean,
						value: true
					},
					success_hidden: {
						type: Boolean,
						value: true
					},
					unregister_hidden: {
						type: Boolean,
						value: true
					}
				},
				ready: function() {
					this.$.userAjax.headers = {
						'Authorization': localStorage.getItem('token')
					};
					this.$.userAjax.generateRequest();
					this.$.tiersAjax.headers = {
						'Authorization': localStorage.getItem('token')
					};
					this.$.tiersAjax.generateRequest();
				},
				userResponse: function(e) {
					var user = e.detail.response;
					this.osu_search_hidden = true;
					this.register_disabled = true;
					this.tier_hidden = true;
					this.register_hidden = true;
					this.no_tier_hidden = true;
					this.link_twitch_hidden = true;
					this.twitch_profile_hidden = true;
					this.success_hidden = true;
					this.unregister_hidden = true;
					this.discord_profile = user.discord_profile;
					this.twitch_profile = user.twitch_profile;
					this.osu_profile = user.registration.osu_profile;
					if (!this.osu_profile) {
						this.osu_search_hidden = false;
						this.register_hidden = false;
					} else {
						this.tier_lower_endpoint = user.registration.tier.lower_endpoint;
						this.tier_upper_endpoint = user.registration.tier.upper_endpoint;
						this.tier_name = user.registration.tier.name;
						this.tier_hidden = false;
						this.success_hidden = false;
						this.unregister_hidden = false;
						if (!this.twitch_profile) {
							this.link_twitch_hidden = false;
						} else {
							this.sub_since = this.twitch_profile.sub_since;
							this.twitch_profile_hidden = false;
						}
					}
				},
				osuIdKeydown: function(e) {
					if (e.keyCode == 13) {
						this.searchOsuProfile();
					}
				},
				searchOsuProfile: function() {
					if (this.osu_id) {
						this.$.osuProfileAjax.url = '../api/osu_profile/' + this.osu_id;
						this.$.osuProfileAjax.headers = {
							'Authorization': localStorage.getItem('token')
						};
						this.$.osuProfileAjax.generateRequest();
					}
				},
				osuProfileResponse: function(e) {
					var profile = e.detail.response;
					if (profile && profile.user_id) {
						this.osu_profile = profile;
						for (var i = 0; i < this.tiers.length; i++) {
							if (parseInt(this.osu_profile.pp_rank) >= parseInt(this.tiers[i].lower_endpoint) && parseInt(this.osu_profile.pp_rank) <= parseInt(this.tiers[i].upper_endpoint)) {
								this.tier_lower_endpoint = this.tiers[i].lower_endpoint;
								this.tier_upper_endpoint = this.tiers[i].upper_endpoint;
								this.tier_name = this.tiers[i].name;
								this.tier_hidden = false;
								this.no_tier_hidden = true;
								this.register_disabled = false;
								return;
							}
						}
						this.tier_hidden = true;
						this.no_tier_hidden = false;
						this.register_disabled = true;
					}
				},
				register: function() {
					if (!this.osu_profile) return;
					this.$.registerAjax.headers = {
						'Authorization': localStorage.getItem('token')
					};
					this.$.registerAjax.body = {
						'action': 'register',
						'osu_id': this.osu_profile.user_id
					};
					this.$.registerAjax.generateRequest();
				},
				unregister: function() {
					this.$.registerAjax.headers = {
						'Authorization': localStorage.getItem('token')
					};
					this.$.registerAjax.body = {
						'action': 'unregister'
					};
					this.$.registerAjax.generateRequest();
				},
				linkTwitch: function() {
					window.location = '../twitch_login_forward.php';
				},
				registerResponse: function(e) {
					var response = e.detail.response;
					this.toast_message = response.message;
					if (response.error == '1') {
						this.$.errorToast.open();
					} else {
						this.$.successToast.open();
					}
					this.$.userAjax.generateRequest();
				},
				logout: function() {
					window.location = '../index.html';
				},
				showUnregister: function() {
					this.$.unregisterDialog.open();
				}
			});
		});
	</script>
</dom-module>